<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gistvox Player</title>
<link rel="icon" href="favicon.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #9EBACF;
  --primary-dark: #7A9AB2;
  --success: #10B981;
  --muted: #6b7280;
  --muted-bg: #f9fafb;
  --border: #e5e7eb;
  --text: #1f2937;
  --text-secondary: #4b5563;
  --ring-color: rgba(158, 186, 207, 0.3);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 350px;
  padding: 16px;
  background: transparent;
  color: var(--text);
}

/* Main container with ring effect like NowPlayingCard */
.gistvox-player {
  background: white;
  border-radius: 16px;
  padding: 14px;
  width: 100%;
  max-width: 380px;
  min-height: 410px;
  position: relative;
  transition: all 0.3s ease;
  box-shadow: 
    0 2px 16px rgba(158, 186, 207, 0.15),
    0 1px 3px rgba(0, 0, 0, 0.05);
  border: 2px solid var(--ring-color);
}

.gistvox-player.playing {
  border-color: rgba(158, 186, 207, 0.5);
  transform: translateY(-2px) scale(1.01);
  box-shadow: 
    0 12px 24px rgba(158, 186, 207, 0.3),
    0 4px 8px rgba(158, 186, 207, 0.15);
}

/* Gistvox Branding Header */
.brand-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.now-playing-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  letter-spacing: -0.2px;
}

.volume-icon {
  width: 16px;
  height: 16px;
  color: var(--primary);
}

.audio-bars {
  display: flex;
  align-items: center;
  gap: 2px;
  height: 12px;
  width: 28px;
}

.audio-bar {
  width: 4px;
  background: var(--primary);
  border-radius: 2px;
  animation: wave 0.8s ease-in-out infinite;
}

.audio-bar:nth-child(1) { animation-delay: 0s; height: 40%; }
.audio-bar:nth-child(2) { animation-delay: 0.1s; height: 60%; }
.audio-bar:nth-child(3) { animation-delay: 0.2s; height: 50%; }
.audio-bar:nth-child(4) { animation-delay: 0.3s; height: 70%; }
.audio-bar:nth-child(5) { animation-delay: 0.4s; height: 45%; }

@keyframes wave {
  0%, 100% { transform: scaleY(0.5); }
  50% { transform: scaleY(1); }
}

.gistvox-link {
  display: flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  color: var(--primary);
  font-size: 13px;
  font-weight: 600;
  transition: opacity 0.2s;
}

.gistvox-link:hover {
  opacity: 0.8;
}

.logo-icon {
  width: 22px;
  height: 22px;
  border-radius: 4px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* User Section */
.user-section {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 16px;
}

.avatar {
  width: 48px;
  height: 48px;
  border-radius: 24px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 18px;
  font-weight: 600;
  flex-shrink: 0;
  overflow: hidden;
  border: 2px solid rgba(158, 186, 207, 0.3);
  position: relative;
}

.avatar.with-image {
  background: white;
  padding: 1px;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.content-info {
  flex: 1;
  min-width: 0;
}

.user-handle {
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  margin-top: 4px;
  margin-bottom: 0;
}

.timestamp {
  font-size: 10px;
  color: var(--muted);
}

.title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  line-height: 1.25;
  margin-bottom: 4px;
}

.date {
  font-size: 10px;
  color: var(--muted);
  margin-bottom: 8px;
}

.description {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.45;
  margin-bottom: 16px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Progress Section */
.progress-section {
  margin-bottom: 8px;
}

.progress-container {
  height: 44px;
  display: flex;
  align-items: center;
  cursor: pointer;
  position: relative;
}

.progress-track {
  position: relative;
  width: 100%;
  height: 12px;
  background: rgba(107, 114, 128, 0.3);
  border-radius: 999px;
  overflow: hidden;
  transition: height 0.15s;
}

.progress-track.dragging {
  height: 15px;
}

.progress-fill {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  background: var(--primary);
  border-radius: 999px;
  transition: width 0.1s;
  box-shadow: 0 2px 8px rgba(158, 186, 207, 0.3);
}

.progress-fill.playing::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, 
    rgba(255,255,255,0) 0%, 
    rgba(255,255,255,0.2) 50%, 
    rgba(255,255,255,0) 100%);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-thumb {
  position: absolute;
  width: 14px;
  height: 14px;
  background: white;
  border: 2px solid var(--primary);
  border-radius: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: width 0.15s, height 0.15s;
}

.progress-thumb.dragging {
  width: 20px;
  height: 20px;
}

.time-display {
  display: flex;
  justify-content: space-between;
  font-family: 'Roboto Mono', monospace;
  font-size: 12px;
  color: var(--muted);
}

.time-display .current.dragging {
  font-weight: 600;
}

/* Controls */
.controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 22px;
  margin: 16px 0 20px 0;
}

.control-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  color: var(--text);
}

.control-btn:disabled {
  color: var(--muted);
  cursor: not-allowed;
}

/* bigger skip/rewind */
.control-btn.skip {
  width: 44px;
  height: 44px;
}

.control-btn.skip svg {
  width: 22px;
  height: 22px;
}

/* bigger play */
.play-btn {
  width: 84px;          /* was 64px */
  height: 84px;         /* was 64px */
  border-radius: 50%;
  border: 2px solid var(--primary);
  background: transparent;
  position: relative;
  transition: all 0.2s;
}

.play-btn.playing {
  background: var(--primary);
  box-shadow: 0 4px 16px rgba(158, 186, 207, 0.35);
}

.play-btn.playing svg { color: white; }
.play-btn:not(.playing) svg { color: var(--primary); }

/* make play icon larger */
.play-btn svg {
  width: 28px;          /* was 18px inline */
  height: 28px;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  margin: 12px 0;
}

.action-row { display: flex; gap: 8px; width: 100%; }

.action-btn {
  flex: 1;
  padding: 10px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  font-size: 12px;
  color: var(--text);
  font-weight: 500;
  transition: all 0.2s;
}

.action-btn:hover {
  background: var(--muted-bg);
  border-color: var(--primary);
}

.action-btn svg { width: 14px; height: 14px; }

/* Stats Bar */
.stats-bar {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 10px 12px;
  margin-top: 12px;
  text-align: center;
}

.stats-text {
  font-family: 'Roboto Mono', monospace;
  font-size: 11.5px;
  font-weight: 400;
  color: var(--muted);
  letter-spacing: -0.2px;
}

/* Loading & Error States */
.loading, .error { text-align: center; padding: 40px; }
.loading { color: var(--muted); }

.loading-spinner {
  width: 30px; height: 30px;
  border: 3px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.error { color: #ef4444; }

/* Dark theme */
body.dark {
  --text: #f1f5f9;
  --text-secondary: #cbd5e1;
  --muted: #64748b;
  --muted-bg: #1e293b;
  --border: #334155;
}
body.dark .gistvox-player { background: #1e293b; }
body.dark .stats-bar { background: #1a1a1a; }

/* Minimal mode */
.minimal .brand-header, .minimal .description, .minimal .stats-bar { display: none; }
.minimal .progress-section { margin-bottom: 4px; }
.minimal .controls { margin: 12px 0; }

/* Responsive */
@media (max-width: 480px) {
  .gistvox-player { padding: 12px; }
  .title { font-size: 14px; }
  .stats-text { font-size: 10px; }
}
</style>
</head>
<body>
<div id="player" class="loading">
  <div class="loading-spinner"></div>
  <div>Loading audio story...</div>
</div>

<script>
// Configuration
const SUPABASE_URL = 'https://vrcshstpoimwpwyyamvq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyY3Noc3Rwb2ltd3B3eXlhbXZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTg4NzEsImV4cCI6MjA3MTE5NDg3MX0.yAJbFPzYTGLwSZFOAVRukwXyNQQ69cdVYwYWvRAkUNc';

// Parse URL parameters
const params = new URLSearchParams(window.location.search);
const postId = params.get('id'); // Read from URL parameter
const theme = params.get('theme') || 'light';
const minimal = params.get('minimal') === 'true';
const autoplay = params.get('autoplay') === 'true';

// State
let audio = null;
let isDragging = false;
let isPlaying = false;
let hasTrackedListen = false;

// Apply theme
if (theme === 'dark') document.body.classList.add('dark');

// Validation
if (!postId || postId.length !== 36) {
  document.getElementById('player').innerHTML = '<div class="error">Invalid or missing post ID</div>';
  throw new Error('Invalid post ID');
}

// Helpers
function timeAgo(date) {
  const seconds = Math.floor((new Date() - new Date(date)) / 1000);
  const intervals = { year:31536000, month:2592000, week:604800, day:86400, hour:3600, minute:60 };
  for (const [name, count] of Object.entries(intervals)) {
    const interval = Math.floor(seconds / count);
    if (interval >= 1) return interval === 1 ? `1 ${name} ago` : `${interval} ${name}s ago`;
  }
  return 'just now';
}
function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}
function formatWithCommas(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
function formatDate(dateStr) {
  const date = new Date(dateStr);
  const month = date.toLocaleString('en', { month: 'short' });
  return `${month} ${date.getDate()}`;
}

// Main
async function loadPlayer() {
  const container = document.getElementById('player');
  try {
    // Fetch post
    const postRes = await fetch(
      `${SUPABASE_URL}/rest/v1/posts?id=eq.${postId}&select=*`,
      { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
    );
    if (!postRes.ok) throw new Error('Failed to fetch post');
    const posts = await postRes.json();
    if (!posts || posts.length === 0) { container.innerHTML = '<div class="error">Story not found</div>'; return; }
    const post = posts[0];

    if (post.audience_type !== 'public') { container.innerHTML = '<div class="error">This story is private</div>'; return; }

    // Fetch user
    let user = { handle: 'anonymous', display_name: 'Anonymous' };
    if (post.user_id) {
      const userRes = await fetch(
        `${SUPABASE_URL}/rest/v1/users?id=eq.${post.user_id}&select=*`,
        { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
      );
      const users = await userRes.json();
      if (users && users.length > 0) user = users[0];
    }

    const branchLink = `https://gistvox.app.link/post/${postId}`;
    const displayName = user.display_name || user.handle || 'Anonymous';
    const initials = displayName[0].toUpperCase();

    container.className = minimal ? 'gistvox-player minimal' : 'gistvox-player';
    container.innerHTML = `
      <div class="brand-header">
        <div class="now-playing-label">
          <svg class="volume-icon" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 3.22L6.603 6H3a1 1 0 00-1 1v6a1 1 0 001 1h3.603L10 16.78V3.22zM14.82 4.58a7.023 7.023 0 010 10.84l-.71-.71a5.975 5.975 0 000-8.42l.71-.71z"/>
          </svg>
          <span>Now Playing</span>
          <div class="audio-bars" id="audioBars" style="display:none">
            <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
          </div>
        </div>
        <a href="${branchLink}" target="_blank" class="gistvox-link">
          <div class="logo-icon">
            <img src="https://vrcshstpoimwpwyyamvq.supabase.co/storage/v1/object/public/gistvox-public/gistvox-logo.png" alt="Gistvox" />
          </div>
        </a>
      </div>

      <div class="user-section">
        <div class="avatar ${user.avatar_url ? 'with-image' : ''}">
          ${user.avatar_url ? `<img src="${user.avatar_url}" alt="${displayName}">` : initials}
        </div>
        <div class="content-info">
          <h3 class="title">${post.title || 'Untitled Story'}</h3>
          <div class="date">${formatDate(post.created_at)}</div>
          <div class="user-handle">@${user.handle || 'anonymous'}</div>
          ${post.description && !minimal ? `<p class="description">${post.description}</p>` : ''}
        </div>
      </div>

      <div class="progress-section">
        <div class="progress-container" id="progressContainer">
          <div class="progress-track" id="progressTrack">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
            <div class="progress-thumb" id="progressThumb" style="left:0%"></div>
          </div>
        </div>
        <div class="time-display">
          <span class="current" id="currentTime">0:00</span>
          <span id="duration">${formatTime(post.audio_duration || 0)}</span>
        </div>
      </div>

      <div class="controls">
        <button class="control-btn skip" id="skipBack" aria-label="Rewind 15 seconds">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/>
          </svg>
        </button>
        <button class="control-btn play-btn" id="playBtn" aria-label="Play/Pause">
          <svg fill="currentColor" viewBox="0 0 20 20" id="playIcon">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
          </svg>
          <svg fill="currentColor" viewBox="0 0 20 20" id="pauseIcon" style="display:none">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"/>
          </svg>
        </button>
        <button class="control-btn skip" id="skipForward" aria-label="Skip forward 15 seconds">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798L4.555 5.168z"/>
          </svg>
        </button>
      </div>

      <audio id="audioPlayer" ${autoplay ? 'autoplay' : ''}>
        <source src="${post.audio_url}" type="audio/mpeg">
      </audio>

      <div class="action-buttons">
        <div class="action-row">
          <button class="action-btn" onclick="handleShare(event)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m9.032 4.026a9.001 9.001 0 01-7.432 0m9.032-4.026A9.001 9.001 0 0112 3c-4.474 0-8.268 2.943-9.543 7a9.97 9.97 0 011.827 3.342m7.432 4.026a9.97 9.97 0 001.827-3.342"/>
            </svg>
            <span>Share</span>
          </button>
          <button class="action-btn" onclick="openInApp()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
            </svg>
            <span>Open in App</span>
          </button>
        </div>
      </div>

      <div class="stats-bar">
        <div class="stats-text">
          ${formatWithCommas(post.listens_count || 0)} listens • 
          ${formatWithCommas(post.likes_count || 0)} likes • 
          ${formatWithCommas(post.saves_count || 0)} saves • 
          ${formatWithCommas(post.shares_count || 0)} shares
        </div>
      </div>
    `;

    setupAudioPlayer();
  } catch (error) {
    console.error('Player error:', error);
    container.innerHTML = '<div class="error">Failed to load story</div>';
  }
}

function setupAudioPlayer() {
  audio = document.getElementById('audioPlayer');
  const playBtn = document.getElementById('playBtn');
  const playIcon = document.getElementById('playIcon');
  const pauseIcon = document.getElementById('pauseIcon');
  const progressContainer = document.getElementById('progressContainer');
  const progressTrack = document.getElementById('progressTrack');
  const progressFill = document.getElementById('progressFill');
  const progressThumb = document.getElementById('progressThumb');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const audioBars = document.getElementById('audioBars');
  const player = document.querySelector('.gistvox-player');
  const skipBack = document.getElementById('skipBack');
  const skipForward = document.getElementById('skipForward');
  const SKIP_SECONDS = 15;

  // Play/Pause
  playBtn.addEventListener('click', () => { audio.paused ? audio.play() : audio.pause(); });

  audio.addEventListener('play', () => {
    playIcon.style.display = 'none';
    pauseIcon.style.display = 'block';
    playBtn.classList.add('playing');
    player.classList.add('playing');
    audioBars.style.display = 'flex';
    progressFill.classList.add('playing');
    
    // Track the listen when play starts
    trackListen();
  });

  audio.addEventListener('pause', () => {
    playIcon.style.display = 'block';
    pauseIcon.style.display = 'none';
    playBtn.classList.remove('playing');
    player.classList.remove('playing');
    audioBars.style.display = 'none';
    progressFill.classList.remove('playing');
  });

  // Enable skip controls
  skipBack.addEventListener('click', () => {
    audio.currentTime = Math.max(0, (audio.currentTime || 0) - SKIP_SECONDS);
  });
  skipForward.addEventListener('click', () => {
    const d = isFinite(audio.duration) ? audio.duration : Number.MAX_SAFE_INTEGER;
    audio.currentTime = Math.min(d, (audio.currentTime || 0) + SKIP_SECONDS);
  });

  // Duration
  audio.addEventListener('loadedmetadata', () => {
    if (isFinite(audio.duration)) durationEl.textContent = formatTime(audio.duration);
  });

  // Progress update
  audio.addEventListener('timeupdate', () => {
    if (!isDragging && audio.duration) {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressFill.style.width = `${percent}%`;
      progressThumb.style.left = `${percent}%`;
      currentTimeEl.textContent = formatTime(audio.currentTime);
    }
  });

  // Drag-to-seek
  let dragStartX = 0;
  const startDrag = (e) => {
    isDragging = true;
    progressTrack.classList.add('dragging');
    progressThumb.classList.add('dragging');
    currentTimeEl.classList.add('dragging');
    const rect = progressContainer.getBoundingClientRect();
    dragStartX = e.clientX || e.touches[0].clientX;
    const percent = ((dragStartX - rect.left) / rect.width) * 100;
    updateProgress(Math.max(0, Math.min(100, percent)));
  };
  const doDrag = (e) => {
    if (!isDragging) return;
    const rect = progressContainer.getBoundingClientRect();
    const currentX = e.clientX || e.touches[0].clientX;
    const percent = ((currentX - rect.left) / rect.width) * 100;
    updateProgress(Math.max(0, Math.min(100, percent)));
  };
  const endDrag = () => {
    if (!isDragging) return;
    isDragging = false;
    progressTrack.classList.remove('dragging');
    progressThumb.classList.remove('dragging');
    currentTimeEl.classList.remove('dragging');
    const percent = parseFloat(progressFill.style.width);
    if (audio.duration) audio.currentTime = (percent / 100) * audio.duration;
  };
  const updateProgress = (percent) => {
    progressFill.style.width = `${percent}%`;
    progressThumb.style.left = `${percent}%`;
    const time = audio.duration ? (percent / 100) * audio.duration : 0;
    currentTimeEl.textContent = formatTime(time);
  };

  progressContainer.addEventListener('click', (e) => {
    if (isDragging) return;
    const rect = progressContainer.getBoundingClientRect();
    const percent = ((e.clientX - rect.left) / rect.width) * 100;
    updateProgress(Math.max(0, Math.min(100, percent)));
    if (audio.duration) audio.currentTime = (percent / 100) * audio.duration;
  });
  progressContainer.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', doDrag);
  document.addEventListener('mouseup', endDrag);
  progressContainer.addEventListener('touchstart', startDrag);
  document.addEventListener('touchmove', doDrag);
  document.addEventListener('touchend', endDrag);

  // Notify parent
  audio.addEventListener('play', () => {
    if (window.parent !== window) {
      window.parent.postMessage({ type: 'gistvox-embed-play', postId }, '*');
    }
  });
}

// Track listen function
async function trackListen() {
  // Only track once per session to avoid spam
  if (hasTrackedListen) {
    console.log('Listen already tracked for this session');
    return;
  }
  
  // Check session storage to prevent multiple counts on page refresh
  const sessionKey = `gistvox_listened_${postId}`;
  if (sessionStorage.getItem(sessionKey)) {
    console.log('Listen already tracked in this browser session');
    hasTrackedListen = true;
    return;
  }
  
  try {
    console.log('Tracking listen for post:', postId);
    
    // Call the RPC function to increment listen count
    const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_listen_count_anon`, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({ p_post_id: postId })
    });
    
    if (!response.ok) {
      console.warn('Failed to track listen:', response.status);
      // Try the simpler version as fallback
      const fallbackResponse = await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_listen_count_simple`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ p_post_id: postId })
      });
      
      if (fallbackResponse.ok) {
        console.log('Listen tracked via fallback method');
      }
    } else {
      const result = await response.json();
      console.log('Listen tracked successfully. New count:', result.count || result);
      
      // Update the displayed count if we have it
      const statsText = document.querySelector('.stats-text');
      if (statsText && result.count) {
        // Parse and update the listens count in the stats
        const currentText = statsText.textContent;
        const newText = currentText.replace(/(\d+(?:,\d+)*) listens/, `${formatWithCommas(result.count)} listens`);
        statsText.textContent = newText;
      }
    }
    
    // Mark as tracked for this session
    hasTrackedListen = true;
    sessionStorage.setItem(sessionKey, 'true');
    
  } catch (error) {
    console.error('Error tracking listen:', error);
    // Don't throw - we don't want to break playback if tracking fails
  }
}

// Actions
window.handleShare = (e) => {
  const shareUrl = `https://embed.gistvox.com/?id=${postId}`;

  const write = async () => {
    try {
      await navigator.clipboard.writeText(shareUrl);
      return true;
    } catch {
      // Fallback for older browsers / insecure contexts
      const ta = document.createElement('textarea');
      ta.value = shareUrl;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }
  };

  write().then((ok) => {
    const btn = e.currentTarget;
    const span = btn.querySelector('span');
    const original = span.textContent;
    span.textContent = ok ? 'Copied!' : 'Copy failed';
    setTimeout(() => { span.textContent = original; }, 2000);
  });
};

window.openInApp = () => {
  const branchLink = `https://gistvox.app.link/post/${postId}`;
  window.open(branchLink, '_blank');
};

// Load
loadPlayer();
</script>
</body>
</html>